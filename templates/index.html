<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurana Chocolate - Бутик Шоколада</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=9"> 
</head>

<body>
    <a name="top"></a>
    
    <header class="header">
        <a href="#top" class="logo">AURANA</a>
        <nav>
            <a href="#catalog">Каталог</a>
            <a href="#about">О нас</a>
            <a href="#delivery">Доставка</a>
            <a href="#order">Заказ</a> 
            <a href="{{ url_for('profile') }}">Личный кабинет</a> 
        </nav>
    </header>

    <section id="hero" class="section hero-section">
        <div class="hero-content">
            <h1>AURANA</h1>
            <p>Искусство создавать эмоции. Крафтовый шоколад с уникальными вкусами.</p>
            <a href="#catalog" class="cta-button">Выбрать шоколад</a>
        </div>
    </section>

    <section id="catalog" class="section">
        <h2>Наш Ассортимент</h2>
        <div class="product-grid">
            {% for product in products %}
            <div class="product-card" data-product-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}">
                <h3>{{ product.name }}</h3>
                <p>Нежный молочный шоколад с уникальными наполнителями.</p>
                <span class="price">{{ product.price }} ₽</span>
                <button class="add-to-cart" data-id="{{ product.id }}">В корзину</button>
            </div>
            {% endfor %}
        </div>
    </section>

    <section id="about" class="section">
        <h2>О нас</h2>
        <div class="info-section">
            <p>AURANA — это страсть к шоколаду, возведенная в искусство. Мы используем только лучшее какао, чтобы создавать плитки с неповторимыми, авторскими вкусами.</p>
            <p>Мы верим, что шоколад должен дарить не только удовольствие, но и удивлять. Насладитесь вкусом, который вы никогда не забудете!</p>
        </div>
    </section>

    <section id="delivery" class="section">
        <h2>Доставка</h2>
        <div class="info-section">
            <p>Доставка осуществляется курьером по Москве и Московской области в течение 1-2 дней после подтверждения заказа.</p>
            <p>Стоимость доставки: по Москве — 350 ₽, за МКАД — 500 ₽. При заказе от 5000 ₽ доставка бесплатна!</p>
            <p>Мы тщательно упаковываем каждый заказ, чтобы шоколад сохранил идеальную форму и свежесть, независимо от погоды.</p>
        </div>
    </section>

    <section id="order" class="section">
        <h2>Ваш Заказ</h2>
        <div class="info-section" style="padding: 20px;">
            <p class="highlight-info">Ваш код клиента: 
                {% if customer_code %}
                    <span class="highlight">{{ customer_code }}</span> 
                {% else %}
                    (Будет присвоен при первом заказе)
                {% endif %}
            </p>
            <p class="greeting-info">
                {% if name %}
                    Здравствуйте, {{ name }}!
                {% else %}
                    Пожалуйста, заполните форму ниже.
                {% endif %}
            </p>

            <ul id="cart-items">
                <li id="cart-empty" style="text-align: center; color: var(--color-text-dim); border: none;">Ваша корзина пуста.</li>
            </ul>
            
            <div id="cart-total" style="display: none; text-align: right; margin-top: 15px; font-size: 1.1em; font-weight: bold;">
                Итого: <span>0</span> ₽
            </div>

            <div class="order-form-container" id="order-form-container">
                <form id="order-form" action="{{ url_for('place_order') }}" method="POST">
                    <label for="name">Ваше Имя:</label>
                    <input type="text" id="name" name="name" value="{{ name or '' }}" required>

                    <label for="contact">Контакт (Email, Telegram или WhatsApp):</label>
                    <input type="text" id="contact" name="contact" placeholder="@telegram / email@example.com" required>

                    <input type="hidden" id="order_details_json" name="order_details_json">

                    <button type="submit" class="submit-button" id="submit-order" disabled>Оформить заказ</button>
                </form>
            </div>
        </div>
    </section>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const products = [
                {% for product in products %}
                    {id: "{{ product.id }}", name: "{{ product.name }}", price: {{ product.price }}},
                {% endfor %}
            ];
            
            let cart = JSON.parse(localStorage.getItem('cart')) || {};

            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');
            const submitButton = document.getElementById('submit-order');
            const orderDetailsInput = document.getElementById('order_details_json');
            
            function saveCart() {
                localStorage.setItem('cart', JSON.stringify(cart));
            }
            
            function renderCart() {
                cartItemsContainer.innerHTML = '';
                let total = 0;
                let cartIsEmpty = true;
                
                for (const productId in cart) {
                    if (cart[productId] > 0) {
                        cartIsEmpty = false;
                        const product = products.find(p => p.id === productId);
                        if (!product) continue;

                        const qty = cart[productId];
                        const itemTotal = qty * product.price;
                        total += itemTotal;

                        const listItem = document.createElement('li');
                        listItem.style.display = 'flex';
                        listItem.style.justifyContent = 'space-between';
                        listItem.style.padding = '8px 0';
                        listItem.innerHTML = `
                            <span style="flex-grow: 1;">${product.name}</span>
                            <div class="cart-controls" style="display: flex; align-items: center;">
                                <button data-id="${productId}" data-action="decrease" style="margin: 0 5px;">-</button>
                                <span style="margin: 0 10px;">${qty} шт.</span>
                                <button data-id="${productId}" data-action="increase" style="margin: 0 5px;">+</button>
                                <span style="margin-left: 15px;">(${itemTotal} ₽)</span>
                            </div>
                        `;
                        cartItemsContainer.appendChild(listItem);
                    }
                }

                if (cartIsEmpty) {
                    cartItemsContainer.innerHTML = '<li id="cart-empty" style="text-align: center; color: #999; border: none;">Ваша корзина пуста.</li>';
                    cartTotalElement.style.display = 'none';
                    submitButton.disabled = true;
                } else {
                    cartTotalElement.querySelector('span').textContent = total;
                    cartTotalElement.style.display = 'block';
                    submitButton.disabled = false;
                }
                
                updateOrderDetails(total);
                saveCart();
            }

            function updateOrderDetails(totalPrice) {
                const details = [];
                for (const productId in cart) {
                    if (cart[productId] > 0) {
                        const product = products.find(p => p.id === productId);
                        details.push({
                            id: productId,
                            name: product.name,
                            price: product.price,
                            qty: cart[productId]
                        });
                    }
                }
                orderDetailsInput.value = JSON.stringify(details);
            }

            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    cart[id] = (cart[id] || 0) + 1;
                    renderCart();
                });
            });

            cartItemsContainer.addEventListener('click', (e) => {
                const target = e.target;
                const id = target.dataset.id;
                const action = target.dataset.action;

                if (id && action) {
                    if (action === 'increase') {
                        cart[id] = (cart[id] || 0) + 1;
                    } else if (action === 'decrease') {
                        cart[id] = (cart[id] || 0) - 1;
                        if (cart[id] <= 0) {
                            delete cart[id];
                        }
                    }
                    renderCart();
                }
            });

            renderCart();
        });
    </script>
</body>
</html>